# Everything defined in this file have prefix PROD_ or (prod-)
# This contains everything to config production environment.
# Credentials are passed by setting environment variables.

# Database Settings

PROD_GCP_DB_KEY_FILE ?=
PROD_GCP_DB_PROJECT ?=
PROD_GCP_DB_REGION ?=
PROD_GCP_DB_INSTANCE ?=
PROD_GCP_DB_USERNAME ?=
PROD_GCP_DB_PASSWORD ?=

# Static IP Settings
PROD_GCP_IP_REGION ?=

# DNS Settings

PROD_GCP_DNS_KEY_FILE ?=

# Ingress Settings

PROD_TLS_CERT_FILE ?=
PROD_TLS_KEY_FILE ?=

# Other Settings

PROD_HELM_COMMON_FLAGS ?= $(HELM_COMMON_FLAGS) \
						--set nginx-ingress.controller.service.loadBalancerIP="$(PROD_GCP_LB_STATIC_IP)" \
						--set postgres.cloudsql.instances[0].instance="$(PROD_GCP_DB_INSTANCE)" \
						--set postgres.cloudsql.instances[0].project="$(PROD_GCP_DB_PROJECT)" \
						--set postgres.cloudsql.instances[0].region="$(PROD_GCP_DB_REGION)" \
						--set postgres.cloudsql.instances[0].port=5432

# Targets

prod-secret-database:
	$(KUBECTL) create secret generic database-secret \
		--from-file=instance-credential="$(PROD_GCP_DB_KEY_FILE)" \
		--from-literal=username="$(PROD_GCP_DB_USERNAME)" \
		--from-literal=password="$(PROD_GCP_DB_PASSWORD)"

prod-secret-tls:
	$(KUBECTL) create secret tls tls-secret \
		--cert="$(PROD_TLS_CERT_FILE)" \
		--key="$(PROD_TLS_KEY_FILE)"

prod-secret-dns:
	$(KUBECTL) create secret generic dns-secret \
		--from-file=key.json="$(PROD_GCP_DNS_KEY_FILE)"

prod-static-ip:
	gcloud compute addresses create static-ip --region $(PROD_GCP_IP_REGION)
PROD_GCP_LB_STATIC_IP = $(shell gcloud compute addresses describe static-ip --region $(PROD_GCP_IP_REGION) 2> /dev/null)

prod-prepare: prod-secret-database prod-secret-tls prod-secret-dns prod-static-ip

prod-helm-init:
	kubectl create -f tiller-rbac-config.yaml
	$(HELM) init --service-account tiller

prod-update-dependencies:
	$(HELM) dependency update

prod-install:
	$(HELM) install $(PROD_HELM_COMMON_FLAGS) --name $(HELM_RELEASE_NAME) .

prod-install-dryrun:
	$(HELM) install $(PROD_HELM_COMMON_FLAGS) --dry-run --debug .

prod-upgrade:
	$(HELM) upgrade $(PROD_HELM_COMMON_FLAGS) --install $(HELM_RELEASE_NAME) .

prod-status:
	$(HELM) status $(HELM_RELEASE_NAME)
