# Everything defined in this file have prefix CI_ or (ci-)
CI_HELM_COMMON_FLAGS ?= $(HELM_COMMON_FLAGS) \
						--wait --set testing=true,notTesting=false

ci: ci-prepare-env ci-build ci-run ci-after-success

ci-prepare-env: ci-install-helm ci-install-minikube ci-git-login ci-docker-login env-kube-local

ci-build: all

ci-run:
	$(HELM) dependency update
	$(HELM) install --name $(HELM_RELEASE_NAME) .
	$(HELM) status $(HELM_RELEASE_NAME)

ci-after-success: ci-docker-push-images ci-tag-the-commit

ci-git-set-username-travis:
	git config user.email "builds@travis-ci.org"
	git config user.name "Travis CI"

ci-git-login:
	@git remote set-url origin $(shell git remote get-url origin | sed "s#https://#https://$(GITHUB_TOKEN)@#g")

ci-docker-login:
	docker login -u $(DOCKER_REGISTRY) -p $(DOCKER_PASSWORD)

ci-docker-push-images: $(addprefix docker-push-app-, $(APPS) $(BASE_APPS))

ci-tag-the-commit:
	git tag $(BUILD_TAG)
	git push origin $(BUILD_TAG)
