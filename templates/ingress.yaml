apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: {{ .Release.Name }}
  labels:
    chart: {{ list .Chart.Name .Chart.Version | join "-" | replace "+" "_" | trunc 63 | trimSuffix "-" }}
    release: {{ .Release.Name }}
    testing: {{ .Values.testing | quote }}
  annotations:
  {{- if .Values.testing }}
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
  {{- else }}
    kubernetes.io/ingress.global-static-ip-name: {{ .Values.staticIP | quote }}
  {{- end }}

spec:
  {{- if not .Values.testing }}
  tls:
  - secretName: {{ .Values.tlsSecret }}
  {{- end }}
  rules:
  - http:
      paths:
      {{- range $app, $appConfig := .Values.appConfigs }}
        {{- if $appConfig.ingress -}}
          {{- with $ }}
            {{- range $i, $ingressConfig:= $appConfig.ingress }}
      - path: {{ $ingressConfig.path | quote }}
        backend:
          serviceName: {{ include "Networking.App.DNSName" (list $app $) }}
          servicePort: {{ $ingressConfig.port | default (index $appConfig.tcpPorts 0) }}
            {{ end -}}
          {{- end -}}
        {{- end -}}
      {{- end }}
